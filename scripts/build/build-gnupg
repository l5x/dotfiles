#!/usr/bin/env bash
# @description build OpenPGP encryption and signing tool
#
# @import console/info
# @dependency git
# @dependency wget
# shellcheck disable=SC2164

main () {
    strict  true
    verbose true

    # apt-get -y install libgnutls-dev bzip2 make gettext texinfo gnutls-bin libgnutls28-dev build-essential libbz2-dev zlib1g-dev

    # gpg --list-keys
    # gpg --keyserver pool.sks-keyservers.net --recv-keys 0x4F25E3B6 0xE0856959 0x33BD3F06 0x7EFD60D9 0xF7E48EDB

    if [[ -d "${HOME}/.gnupg-dist" ]]
    then
        rm -rf "${HOME}/.gnupg-dist"
    fi

    mkdir -p "${HOME}/.gnupg-dist"

    cd "${HOME}/.gnupg-dist" || exit

    wget -c ftp://ftp.gnupg.org/gcrypt/libgpg-error/libgpg-error-1.25.tar.gz
    wget -c ftp://ftp.gnupg.org/gcrypt/libgpg-error/libgpg-error-1.25.tar.gz.sig
    wget -c ftp://ftp.gnupg.org/gcrypt/libgcrypt/libgcrypt-1.7.3.tar.gz
    wget -c ftp://ftp.gnupg.org/gcrypt/libgcrypt/libgcrypt-1.7.3.tar.gz.sig
    wget -c ftp://ftp.gnupg.org/gcrypt/libassuan/libassuan-2.4.3.tar.bz2
    wget -c ftp://ftp.gnupg.org/gcrypt/libassuan/libassuan-2.4.3.tar.bz2.sig
    wget -c ftp://ftp.gnupg.org/gcrypt/libksba/libksba-1.3.5.tar.bz2
    wget -c ftp://ftp.gnupg.org/gcrypt/libksba/libksba-1.3.5.tar.bz2.sig
    wget -c ftp://ftp.gnupg.org/gcrypt/npth/npth-1.3.tar.bz2
    wget -c ftp://ftp.gnupg.org/gcrypt/npth/npth-1.3.tar.bz2.sig
    wget -c ftp://ftp.gnu.org/gnu/ncurses/ncurses-6.0.tar.gz
    wget -c ftp://ftp.gnu.org/gnu/ncurses/ncurses-6.0.tar.gz.sig
    wget -c ftp://ftp.gnupg.org/gcrypt/pinentry/pinentry-1.0.0.tar.bz2
    wget -c ftp://ftp.gnupg.org/gcrypt/pinentry/pinentry-1.0.0.tar.bz2.sig
    wget -c ftp://ftp.gnupg.org/gcrypt/gnupg/gnupg-2.1.9.tar.bz2
    wget -c ftp://ftp.gnupg.org/gcrypt/gnupg/gnupg-2.1.9.tar.bz2.sig

    gpg --verify libgpg-error-1.25.tar.gz.sig && tar -xzf libgpg-error-1.25.tar.gz
    gpg --verify libgcrypt-1.7.3.tar.gz.sig && tar -xzf libgcrypt-1.7.3.tar.gz
    gpg --verify libassuan-2.4.3.tar.bz2.sig && tar -xjf libassuan-2.4.3.tar.bz2
    gpg --verify libksba-1.3.5.tar.bz2.sig && tar -xjf libksba-1.3.5.tar.bz2
    gpg --verify npth-1.3.tar.bz2.sig && tar -xjf npth-1.3.tar.bz2
    gpg --verify ncurses-6.0.tar.gz.sig && tar -xzf ncurses-6.0.tar.gz
    gpg --verify pinentry-1.0.0.tar.bz2.sig && tar -xjf pinentry-1.0.0.tar.bz2
    gpg --verify gnupg-2.1.9.tar.bz2.sig && tar -xjf gnupg-2.1.9.tar.bz2

    cd libgpg-error-1.25/ && ./configure && make && sudo make install && cd ../
    cd libgcrypt-1.7.3 && ./configure && make && sudo make install && cd ../
    cd libassuan-2.4.3 && ./configure && make && sudo make install && cd ../
    cd libksba-1.3.5 && ./configure && make && sudo make install && cd ../
    cd npth-1.3 && ./configure && make && sudo make install && cd ../
    cd ncurses-6.0 && CPPFLAGS=-P ./configure && make && sudo make install && cd ../
    cd pinentry-1.0.0 && ./configure --enable-pinentry-curses --disable-pinentry-qt4 && make && sudo make install && cd ../
    cd gnupg-2.1.9 && ./configure && make && sudo make install

    echo "/usr/local/lib" | sudo tee /etc/ld.so.conf.d/gpg2.conf
    sudo ldconfig -v

    _ info "Done."
}

# onExit () {
#     _ info "Removing temporary files and directories."
#
#     if [[ -d "${HOME}/.gnupg-dist" ]]
#     then
#         rm -rf "${HOME}/.gnupg-dist"
#     fi 
# }
